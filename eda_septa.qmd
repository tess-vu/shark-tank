---
title: SEPTA
subtitle: Exploratory Data Analysis
date: today
author:
  - name: Angel Rutherford
  - name: Ixchel Ramirez
  - name: Tess Vu
    email:
      - tessavu@proton.me
      - tessavu@upenn.edu
affiliation:
  - name: University of Pennsylvania
    department: Urban Spatial Analytics (MUSA)
    city: Philadelphia
    state: PA
    url: https://www.design.upenn.edu/urban-spatial-analytics
format:
  html:
    code-fold: show
    toc: true
    toc_float: true
    toc-expand: true
    smooth-scroll: true
    embed-resources: true
    title-block-style: default
execute:
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
---

# Setup and Data Preparation

```{r setup}
# Load essential R language libraries for data manipulation and visualization.
library(tidyverse)
library(lubridate)
library(dplyr)
library(stringr)
library(sf)
library(scales)
library(patchwork)

# Disable scientific notation for clearer numeric display.
options(scipen = 999)
```

```{r data-prep}
# Load core panel data for spatio-temporal analysis.
df_septa <- read.csv("data/septa/Bus_Ridership_by_Census_Tract.csv")

# Convert Season column to extract numeric year for time series analysis.
df_septa <- df_septa %>%
  mutate(Year = as.numeric(str_extract(Season, "\\d{4}")))

# Filter out NA values in On_ column which could skew aggregation counts.
df_septa <- df_septa %>%
  filter(!is.na(On_))

# View summary statistics of cleaned data.
summary(df_septa)
```

# Histograms of On and Off

```{r on-off-distribution}
#| fig-dpi: 300
#| fig-height: 10
#| fig-width: 10

# Pivot On_ and Off_ counts into long format.
df_long <- df_septa %>%
  pivot_longer(
    cols = c(On_, Off_),
    names_to = "Ridership_Type_Raw",
    values_to = "Count"
  ) %>%
  mutate(
    # Clean labels for the facet rows.
    Ridership_Type = case_when(
      Ridership_Type_Raw == "On_" ~ "On Count",
      Ridership_Type_Raw == "Off_" ~ "Off Count"
    )
  )

# Create log(Count + 1) transformation for the Log scale plots.
df_hist_data <- df_long %>%
  mutate(
    Log_Count = log10(Count + 1),
    # Set Original Count as initial scale factor.
    Scale = factor(
      "Raw Count",
      levels = c("Raw Count", "Log10(Count + 1)")
    )
  )

# Duplicate data and set Scale factor to Log10 for the second column of facets.
df_log_data <- df_hist_data %>%
  mutate(
    Count = Log_Count,
    Scale = factor("Log10(Count + 1)", levels = c("Raw Count", "Log10(Count + 1)"))
  )

# Combine original counts and log counts for the final 2x2 dataframe.
df_final_hist <- bind_rows(df_hist_data, df_log_data) %>%
  filter(!is.na(Count))

# Visualize distributions using facet_grid for explicit 2x2 layout.
dist_plot <- ggplot(df_final_hist, aes(x = Count, fill = Ridership_Type)) +
  # Use position = "identity" and alpha to allow visibility of both distributions.
  geom_histogram(bins = 50, position = "identity", alpha = 0.6) + 
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Ridership Distribution Comparison (On vs. Off)",
    subtitle = "Faceted histograms justify the use of Count Models due to skewness.",
    x = "Ridership Count",
    y = "Frequency (Number of Tracts)",
    fill = "Type"
  ) +
  facet_grid(Ridership_Type ~ Scale, scales = "free") +
  theme_minimal()

# Plot shows comparison of raw and log-transformed distributions in 2x2 grid.

# Display plot showing justification for Count Model choice.
dist_plot
```

# Annual Ridership Trend (Total System)

```{r annual-ridership}
# Calculate total system-wide boardings per year for time series.
annual_trend <- df_septa %>%
  group_by(Year) %>%
  summarize(Total_On = sum(On_),.groups = "drop")

# Visualize total ridership trend over time with pandemic marker.
annual_plot <- ggplot(annual_trend, aes(x = Year, y = Total_On)) +
  geom_line(color = "darkblue", linewidth = 1.2) +
  geom_point(color = "darkblue", size = 3) +
  geom_vline(xintercept = 2019.5, linetype = "dashed", color = "red") +
  labs(
    title = "Annual System Ridership: 2014 - 2023",
    subtitle = "Vertical red line marks pre-pandemic baseline (Fall 2019).",
    x = "Year (Fall Season)",
    y = "Total Average Daily Boardings"
  )

# Display annual ridership plot showing pandemic impact.
annual_plot
```

# Weekday vs. Weekend Recovery Comparison

```{r weekday-weekend}
# Calculate total boardings grouped by year and day type for comparison.
day_type_trend <- df_septa %>%
  group_by(Year, Day_of_Week) %>%
  summarize(Total_On = sum(On_),.groups = "drop") %>%
  ungroup()

# Visualize recovery curves comparing weekday versus weekend patterns.
day_type_plot <- ggplot(day_type_trend, aes(x = Year, y = Total_On, color = Day_of_Week)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  labs(
    title = "Recovery Disparity: Weekday vs. Weekend Ridership",
    subtitle = "Difference highlights shifts in commuting versus essential/leisure travel.",
    x = "Year (Fall Season)",
    y = "Total Average Daily Boardings",
    color = "Day Type"
  )

# Display day type comparison plot showing differential recovery rates.
day_type_plot
```

# Spatial Proxy: Ridership Change by County

```{r ridership-county}
# Calculate average boardings and recovery ratio for each county.
county_recovery <- df_septa %>%
  filter(Year %in% c(2019, 2023)) %>%
  group_by(County_Name, Year) %>%
  summarize(Avg_On = mean(On_),.groups = "drop") %>%
  pivot_wider(names_from = Year, values_from = Avg_On, names_prefix = "Avg_On_") %>%
  mutate(Recovery_Ratio = Avg_On_2023 / Avg_On_2019)

# Display table of county-level recovery ratios.
print(county_recovery)
```

# Census Tract Ridership Map

```{r ridership-tract-on}
# Load Pennsylvania census tract geometry for spatial visualization.
tract_geo <- st_read("data/pa_tracts/pa_tracts.shp")

# Define FIPS codes for Philadelphia and surrounding counties.
septa_county_fips <- c("017", "029", "045", "091", "101")

# Alternative: Philadelphia only.
# septa_county_fips <- c("101")

# Transform to WGS84 coordinate system and filter to SEPTA service area.
final_map_base <- tract_geo %>%
  st_transform(4326) %>%
  filter(COUNTYFP %in% septa_county_fips)

# Calculate total ridership by census tract for Fall 2023.
current_ridership <- df_septa %>%
  filter(Year == 2023) %>%
  group_by(Census_Tract_ID) %>%
  summarize(
    Final_On_Count = sum(On_),
    Final_Off_Count = sum(Off_)
  ) %>%
  mutate(Census_Tract_ID = as.character(Census_Tract_ID))

# Join ridership data to geometry for spatial visualization.
tract_map_data <- final_map_base %>%
  left_join(current_ridership, by = c("GEOID" = "Census_Tract_ID"))

# Filter to only tracts with recorded ridership data.
tract_map_data_with_ridership <- tract_map_data %>%
  filter(!is.na(Final_On_Count))

# Load SEPTA transit route geometry for network visualization.
routes <- st_read("data/septa/Transit_Routes_Spring_2025/Transit_Routes.shp")
```

```{r ridership-tract-map}
#| fig-dpi: 300
#| fig-height: 20
#| fig-width: 14

# Create choropleth map of boarding counts using log scale transformation.
spatial_plot_log_on <- ggplot(tract_map_data_with_ridership) +
  geom_sf(aes(fill = Final_On_Count + 1), color = "#ff4100", linewidth = 0.25) +
  scale_fill_viridis_c(
    name = "Avg Daily Boardings",
    trans = "log10",
    labels = comma,
    na.value = "gray",
    option = "mako",
    direction = -1
  ) +
  labs(
    title = "Spatial Distribution of Bus Ridership (Fall 2023)",
    subtitle = "Geographic clustering of log(Rider On Count + 1)"
  ) +
  theme_void() +
  theme(plot.background = element_rect(fill = "#dedbd4", color = "#dedbd4"))

# Create choropleth map of alighting counts using log scale transformation.
spatial_plot_log_off <- ggplot(tract_map_data_with_ridership) +
  geom_sf(aes(fill = Final_Off_Count + 1), color = "#ff4100", linewidth = 0.25) +
  scale_fill_viridis_c(
    name = "Avg Daily Alightings",
    trans = "log10",
    labels = comma,
    na.value = "gray",
    option = "mako",
    direction = -1
  ) +
  labs(
    title = "Spatial Distribution of Bus Ridership (Fall 2023)",
    subtitle = "Geographic clustering of log(Rider Off Count + 1)"
  ) +
  theme_void() +
  theme(plot.background = element_rect(fill = "#dedbd4", color = "#dedbd4"))

# Create map showing complete SEPTA route network over census tracts.
septa_route_map <- ggplot(tract_map_data_with_ridership) +
  geom_sf(fill = NA, color = "#ff4100", linewidth = 0.25) +
  geom_sf(data = routes, color = "#778ac5", fill = NA, linewidth = 0.5) +
  scale_color_discrete() +
  labs(
    title = "SEPTA Routes",
    subtitle = "All SEPTA Routes"
  ) +
  theme_void() +
  theme(plot.background = element_rect(fill = "#dedbd4", color = "#dedbd4"))

# Combine all three maps vertically with shared legend at bottom.
(septa_route_map / spatial_plot_log_on / spatial_plot_log_off) +
  plot_layout(guides = "collect") &
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal"
  )
```

# Mode Recovery Index

```{r mode-recovery-index}
#| fig-dpi: 300
#| fig-height: 6
#| fig-width: 12

# Load average daily ridership data by transit mode for comparison.
df_mode <- read.csv("data/septa/Average_Daily_Ridership_By_Mode.csv")

# Filter to key transit modes and calculate recovery index relative to 2019.
df_mode_clean <- df_mode %>%
  filter(Mode %in% c("Bus", "Regional Rail", "Heavy Rail")) %>%
  group_by(Mode) %>%
  mutate(Baseline_2019 = mean(Average_Daily_Ridership[Calendar_Year == 2019], na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    Recovery_Index = (Average_Daily_Ridership / Baseline_2019) * 100,
    Date = make_date(Calendar_Year, Calendar_Month)
  ) %>%
  filter(Calendar_Year <= 2024)

# Create line plot showing recovery trajectories by mode over time.
mode_recovery_plot <- ggplot(df_mode_clean, aes(x = Date, y = Recovery_Index, color = Mode)) +
  geom_line(linewidth = 1.2) +
  geom_hline(yintercept = 100, linetype = "dashed", color = "gray50") +
  labs(
    title = "System Recovery Index by Mode (2019 = 100)",
    subtitle = "Bus mode shows structurally faster ridership recovery than rail.",
    x = "Date",
    y = "Average Daily Ridership Index",
    color = "Mode"
  ) +
  theme_minimal()

# Display mode recovery comparison plot.
mode_recovery_plot
```

# Route Recovery Rank

```{r route-recovery-rank}
#| fig-dpi: 300
#| fig-height: 6
#| fig-width: 12

# Load average daily ridership data by individual route for ranking.
df_route <- read.csv("data/septa/Average_Daily_Ridership_By_Route.csv")

# Calculate recovery ratio for each route comparing 2023 to 2019 baseline.
route_recovery <- df_route %>%
  filter(Calendar_Month %in% c(9, 10, 11)) %>%
  group_by(Route, Calendar_Year) %>%
  summarize(Avg_Ridership = mean(Average_Daily_Ridership), .groups = "drop") %>%
  pivot_wider(names_from = Calendar_Year, values_from = Avg_Ridership, names_prefix = "Y") %>%
  filter(!is.na(Y2019) & !is.na(Y2023)) %>%
  mutate(Recovery_Ratio = Y2023 / Y2019) %>%
  arrange(desc(Recovery_Ratio))

# Create horizontal bar chart showing top 10 routes by recovery ratio.
route_recovery_plot <- ggplot(head(route_recovery, 10), aes(x = reorder(Route, Recovery_Ratio), y = Recovery_Ratio)) +
  geom_col(fill = "darkorange") +
  coord_flip() +
  labs(
    title = "Top 10 Bus Routes by Recovery Rate",
    subtitle = "Routes with highest recovery ratio since 2019 baseline (Recovery Ratio > 1).",
    x = "Bus Route",
    y = "Recovery Ratio (Avg 2023 / Avg 2019)"
  ) +
  theme_minimal()

# Display route recovery ranking plot.
route_recovery_plot
```

# Regional Rail Station Role

```{r regional-rail}
#| fig-dpi: 300
#| fig-height: 8
#| fig-width: 12

# Load regional rail station summary data for commuter pattern analysis.
df_rr <- read.csv("data/septa/Regional_Rail_Station_Summary.csv")

# Calculate commuter score based on weekday versus weekend boarding balance.
rr_station_balance <- df_rr %>%
  filter(Year == 2023) %>%
  group_by(Station, Service_Ty) %>%
  summarize(Total_Boardings = sum(Boards), .groups = "drop") %>%
  pivot_wider(names_from = Service_Ty, values_from = Total_Boardings, values_fill = 0) %>%
  rename(Weekend_Boards = Saturday) %>%
  mutate(Commuter_Score = (Weekday - Weekend_Boards) / (Weekday + Weekend_Boards)) %>%
  filter(Weekday + Weekend_Boards > 100)

# Create scatter plot showing station role classification by boarding patterns.
rr_balance_plot <- ggplot(rr_station_balance, aes(x = Weekday + 1, y = Weekend_Boards + 1, color = Commuter_Score)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_gradient2(
    low = "green",
    mid = "gold",
    high = "red",
    midpoint = 0,
    name = "Commuter Score (Red = Weekday-Dominant)"
  ) +
  labs(
    title = "Regional Rail Station Role: Weekday vs. Weekend Boardings (2023)",
    subtitle = "Diagonal line indicates 'All-Day' stations (Weekday = Weekend)",
    x = "Weekday Boardings (Log(Count + 1))",
    y = "Weekend Boardings (Log(Count + 1))"
  ) +
  scale_x_log10(labels = comma) +
  scale_y_log10(labels = comma) +
  theme_minimal()

# Display regional rail station role classification plot.
rr_balance_plot
```
