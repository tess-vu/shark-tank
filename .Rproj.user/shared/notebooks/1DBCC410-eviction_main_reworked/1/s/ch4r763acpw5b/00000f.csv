"0","# Calculate lagged spatial lag of filings for each month."
"0","# Use neighbors' filings from month t-1 (previous month)."
"0","# Using same-month neighbor data would be data leakage since we wouldn't have that info at prediction time."
"0",""
"0","# Create function to calculate spatial lag for a given month using previous month's data."
"0","calculate_lagged_spatial_lag <- function(data, sf_data, weights, target_date) {"
"0","  "
"0","  # Get previous month's date."
"0","  prev_month_date <- target_date %m-% months(1)"
"0","  "
"0","  # Filter data to previous month."
"0","  prev_month_data <- data %>%"
"0","    filter(date == prev_month_date) %>%"
"0","    select(GEOID, filings_count)"
"0","  "
"0","  # If no previous month data exists, return NA."
"0","  if (nrow(prev_month_data) == 0) {"
"0","    result <- sf_data %>%"
"0","      st_drop_geometry() %>%"
"0","      select(GEOID) %>%"
"0","      mutate("
"0","        date = target_date,"
"0","        spatial_lag_filings = NA_real_"
"0","      )"
"0","    return(result)"
"0","  }"
"0","  "
"0","  # Match order to spatial data."
"0","  sf_matched <- sf_data %>%"
"0","    left_join(prev_month_data, by = ""GEOID"") %>%"
"0","    mutate(filings_count = ifelse(is.na(filings_count), 0, filings_count))"
"0","  "
"0","  # Calculate spatial lag for weighted average of neighbors' previous month filings."
"0","  spatial_lag <- lag.listw(weights, sf_matched$filings_count, zero.policy = TRUE)"
"0","  "
"0","  # Return as dataframe with the target date, not lag date."
"0","  result <- sf_data %>%"
"0","    st_drop_geometry() %>%"
"0","    select(GEOID) %>%"
"0","    mutate("
"0","      date = target_date,"
"0","      spatial_lag_filings = spatial_lag"
"0","    )"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# Get unique dates in data."
"0","unique_dates <- sort(unique(df_model_prep$date))"
"0",""
"0","# Calculate lagged spatial lag for each month."
"0","spatial_lag_df <- map_dfr(unique_dates, function(d) {"
"0","  calculate_lagged_spatial_lag(df_model_prep, philly_model_sf, weights_matrix, d)"
"0","})"
"0",""
"0","# Merge spatial lag back to main data."
"0","df_model_prep <- df_model_prep %>%"
"0","  left_join(spatial_lag_df, by = c(""GEOID"", ""date""))"
"0",""
"0","cat(sprintf(""Observations with spatial lag: %s\n"", "
"0","            comma(sum(!is.na(df_model_prep$spatial_lag_filings)))))"
"1","Observations with spatial lag: 28,560
"
"0","cat(sprintf(""First month has NA spatial lag because of no prior month data: %s observations\n"","
"0","            comma(sum(is.na(df_model_prep$spatial_lag_filings)))))"
"1","First month has NA spatial lag because of no prior month data: 408 observations
"
